{% extends 'peerinst/base.html' %}

{% load compress staticfiles add_class i18n %}

{% block stylesheets %}
{% compress css %}
<link href="{% static 'peerinst/css/authorship.min.css' %}" rel="stylesheet">
{% endcompress %}
{% endblock %}

{% block body %}
<main>
<section>
  <div class="meta-container">
    <div class="container">
      <h1 class="mdc-typography--display3" style="position:sticky;">{% trans 'Question' %}
        <svg class="underline" width=150 height=4></svg>
      </h1>

      {% if object and not object.user == request.user %}
      <div class="admin-link">
      {% trans 'Created by' %}<i class="material-icons md-18 inline mdc-theme--primary">keyboard_arrow_right</i><span>{{ object.user }}</span>
      </div>
      {% endif %}

      {% if object %}
      <h2 class="mdc-typography--display1 mdc-theme--primary">{% trans 'Edit question parameters' %}</h2>
      {% else %}
      <h2 class="mdc-typography--display1 mdc-theme--primary">{% trans 'Step 1: Question parameters' %}</h2>
      {% endif %}

      <form id="question-create-form" enctype="multipart/form-data" method="post">
        {% csrf_token %}

        <h3>Content</h3>

        <div class='field-container'>
          <div class='number-box flush-to-textbox'><span class='number'>1</span></div>
          <div class='field'>
            <div class="mdc-text-field mdc-text-field--outlined mdc-text-field--dense" data-mdc-auto-init="MDCTextField">
              {{ form.title|add_class:"mdc-text-field__input" }}
              {{ form.title.label_tag|add_class:"mdc-floating-label"|cut:":" }}
              <div class="mdc-notched-outline">
                <svg>
                  <path class="mdc-notched-outline__path"/>
                </svg>
              </div>
              <div class="mdc-notched-outline__idle"></div>
            </div>
            <p class="mdc-text-field-helper-text mdc-text-field-helper-text--persistent" aria-hidden="true">
              {{ form.title.help_text|safe }}
            </p>
            {{ form.title.errors }}
          </div>
        </div>

        <div class='field-container'>
          <div class='number-box flush-to-textbox'><span class='number'>2</span></div>
          <div class='field'>
            <div class="mdc-text-field mdc-text-field--textarea mdc-text-field--dense mdc-theme--background" data-mdc-auto-init="MDCTextField">
              {{ form.text|add_class:"mdc-text-field__input" }}
              <label for="id_text" class="mdc-floating-label"> {{ form.text.label }}</label>
            </div>
            <p style='margin-left:16px;margin-right:16px;' class="mdc-text-field-helper-text mdc-text-field-helper-text--persistent" aria-hidden="true">
              {{ form.text.help_text|safe }}
            </p>
            {{ form.text.errors }}
          </div>
        </div>

        <div class='field-container'>
          <div class='number-box'><span class='number'>3</span></div>
          <div class='field'>
            <div class='mdc-form-field'>
              <label for='id_image'>{{ form.image.label }}:</label>{{ form.image }} <span class='mdc-typography--body1' id='warning' style='display:none;color:red;'>{% trans 'File too large' %}</span>
            </div>
            <p class="form-helper-text" aria-hidden="true">
              {{ form.image.help_text|safe }}
            </p>
            {{ form.image.errors }}
          </div>

          <div class='field'>
            <div class="mdc-text-field mdc-text-field--outlined mdc-text-field--dense" data-mdc-auto-init="MDCTextField">
              {{ form.image_alt_text|add_class:"mdc-text-field__input" }}
              {{ form.image_alt_text.label_tag|add_class:"mdc-floating-label"|cut:":" }}
              <div class="mdc-notched-outline">
                <svg>
                  <path class="mdc-notched-outline__path"/>
                </svg>
              </div>
              <div class="mdc-notched-outline__idle"></div>
            </div>
            <p class="mdc-text-field-helper-text mdc-text-field-helper-text--persistent" aria-hidden="true">
              {{ form.image_alt_text.help_text|safe }}
            </p>
            {{ form.image_alt_text.errors }}
          </div>
        </div>

        <div class='field-container'>
          <div class='number-box flush-to-textbox'><span class='number'>4</span></div>
          <div class='field'>
            <div class="mdc-text-field mdc-text-field--outlined mdc-text-field--dense" data-mdc-auto-init="MDCTextField">
              {{ form.video_url|add_class:"mdc-text-field__input" }}
              {{ form.video_url.label_tag|add_class:"mdc-floating-label"|cut:":" }}
              <div class="mdc-notched-outline">
                <svg>
                  <path class="mdc-notched-outline__path"/>
                </svg>
              </div>
              <div class="mdc-notched-outline__idle"></div>
            </div>
            <p class="mdc-text-field-helper-text mdc-text-field-helper-text--persistent" aria-hidden="true">
              {{ form.video_url.help_text|safe }}
            </p>
            {{ form.video_url.errors }}
          </div>
        </div>

        <div class='field-container'>
          <div class='number-box'><span class='number'>5</span></div>
          <div class='field'>
            <div class='mdc-form-field'>
              <label for='id_answer_style'>{{ form.answer_style.label }}:</label>
              <div class='mdc-select'>
                {{ form.answer_style|add_class:"mdc-select__native-control" }}
                <div class="mdc-select__bottom-line"></div>
              </div>
            </div>
            <p class="form-helper-text" aria-hidden="true">
              {{ form.answer_style.help_text|safe }}
            </p>
            {{ form.answer_style.errors }}
          </div>
        </div>


        <h3>Indexing</h3>

        <div class='field-container'>
          <div class='number-box'><span class='number'>6</span></div>
          <div class='field'>
            <div id='discipline_form'>
              {% include 'peerinst/discipline_select_form.html' %}
            </div>
            <p class="form-helper-text" aria-hidden="true">
              {{ form.discipline.help_text|safe }}
            </p>
            {{ form.discipline.errors }}
          </div>
        </div>

        <div class='field-container'>
          <div class='number-box'><span class='number'>7</span></div>
          <div class='field'>
            <div class='mdc-form-field'>
              <label for='id_category'>{{ form.category.label }}:</label>
              {{ form.category|add_class:'multiple-select mdc-theme--background' }}
              <i id='add_category' class="material-icons mdc-theme--primary md-18 add">add_circle</i>
            </div>
            <p class="form-helper-text" aria-hidden="true">
              {{ form.category.help_text|safe }}
            </p>
            {{ form.category.errors }}
          </div>
        </div>

        <h3>Options</h3>

        <div class='field-container'>
          <div class='number-box'><span class='number'>8</span></div>
          <div class='field'>
            <div class='mdc-form-field'>
              <label for="id_sequential_review">{{ form.fake_attributions.label }}?</label>
              <div class="mdc-checkbox">
                {{ form.fake_attributions|add_class:'mdc-checkbox__native-control'}}
                <div class="mdc-checkbox__background">
                  <svg class="mdc-checkbox__checkmark"
                       viewBox="0 0 24 24">
                    <path class="mdc-checkbox__checkmark-path"
                          fill="none"
                          stroke="white"
                          d="M1.73,12.91 8.1,19.28 22.79,4.59"/>
                  </svg>
                  <div class="mdc-checkbox__mixedmark"></div>
                </div>
              </div>
            </div>
            <p class="form-helper-text" aria-hidden="true">
              {{ form.fake_attributions.help_text|safe }}
            </p>
            {{ form.fake_attributions.errors }}
          </div>
        </div>

        <div class='field-container'>
          <div class='number-box'><span class='number'>9</span></div>
          <div class='field'>
            <div class='mdc-form-field'>
              <label for="id_sequential_review">{{ form.sequential_review.label }}?</label>
              <div class="mdc-checkbox">
                {{ form.sequential_review|add_class:'mdc-checkbox__native-control'}}
                <div class="mdc-checkbox__background">
                  <svg class="mdc-checkbox__checkmark"
                       viewBox="0 0 24 24">
                    <path class="mdc-checkbox__checkmark-path"
                          fill="none"
                          stroke="white"
                          d="M1.73,12.91 8.1,19.28 22.79,4.59"/>
                  </svg>
                  <div class="mdc-checkbox__mixedmark"></div>
                </div>
              </div>
            </div>
            <p class="form-helper-text" aria-hidden="true">
              {{ form.sequential_review.help_text|safe }}
            </p>
            {{ form.sequential_review.errors }}
          </div>
        </div>

        <div class='field-container'>
          <div class='number-box'><span class='number'>10</span></div>
          <div class='field'>
            <div class='mdc-form-field'>
              <label for='id_discipline'>{{ form.rationale_selection_algorithm.label }}:</label>
              <div class='mdc-select'>
                {{ form.rationale_selection_algorithm|add_class:"mdc-select__native-control" }}
                <div class="mdc-select__bottom-line"></div>
              </div>
            </div>
            <p class="form-helper-text" aria-hidden="true">
              {{ form.rationale_selection_algorithm.help_text|safe }}
            </p>
            {{ form.rationale_selection_algorithm.errors }}
          </div>
        </div>

        <div class='field-container'>
          <div class='number-box'><span class='number'>11</span></div>
          <div class='field'>
            <div class='mdc-form-field'>
              <label for='id_discipline'>{{ form.grading_scheme.label }}:</label>
              <div class='mdc-select'>
                {{ form.grading_scheme|add_class:"mdc-select__native-control" }}
                <div class="mdc-select__bottom-line"></div>
              </div>
            </div>
            <p class="form-helper-text" aria-hidden="true">
              {{ form.grading_scheme.help_text|safe }}
            </p>
            {{ form.grading_scheme.errors }}
          </div>
        </div>

        {% if not object or object.user == request.user %}
        <div>
        {% else %}
        <div style="display:none;">
        {% endif %}
          <h3>Authorship</h3>

          <div class='field-container'>
            <div class='number-box'><span class='number'>12</span></div>
            <div class='field'>
              <div class='mdc-form-field'>
                <label for='id_collaborators'>{{ form.collaborators.label }}:</label>
                {{ form.collaborators|add_class:'multiple-select mdc-theme--background' }}
              </div>
              <p class="form-helper-text" aria-hidden="true">
                {{ form.collaborators.help_text|safe }}
              </p>
              {{ form.collaborators.errors }}
            </div>
          </div>
        </div>
      </form>

      <div style="margin-top:20px;">
        {% if object %}
        <span class="padded">
          <input form="question-create-form" class="mdc-button mdc-button--raised" type="submit" value="Save and next" />
        </span>

        <span class="padded">
          <form style="display:inline" id="next" action="{% url 'answer-choice-form' question_id=object.pk %}" method="get">
            <button form="next" type="submit" class="mdc-button mdc-button--raised">Next</button>
          </form>
        </span>
        {% else %}
        <span class="padded">
          <input form="question-create-form" class="mdc-button mdc-button--raised" type="submit" value="Add" />
        </span>
        {% endif %}
      </div>
    </div>
  </div>

</main>
</section>

{% endblock %}

{% block scripts %}
<script>
  bundle.bindCheckbox();

  function bindOnClick() {
    'use strict';
    var d = document.getElementById('show_discipline_form');
    if (d) {
      d.onclick = function() {
        function callback() {
          bundle.autoInit();
          var input = this.querySelector('.mdc-text-field__input');
          input.focus();
        }
        $('#discipline_form').load("{% url 'discipline-create' %}", callback);
      }
    }
  }
  bindOnClick();

  function limitFileSize() {
    'use strict';
    var imageForm = document.getElementById('id_image');
    var warning = document.getElementById('warning');
    imageForm.setAttribute('accept', '.png, .jpg, .jpeg, .gif');
    imageForm.onchange = function() {
      var fileSize = imageForm.files[0].size;
      if (fileSize > 1000000) {
        window.alert('File too big: '+fileSize/1000+'kB');
        warning.style.display = 'inline';
        [].forEach.call(document.querySelectorAll('.mdc-button'),
          function(el) {
            el.disabled=true;
          }
        );
      }
      else {
        warning.style.display = 'none';
        [].forEach.call(document.querySelectorAll('.mdc-button'),
          function(el) {
            el.disabled=false;
          }
        );
      }
      return;
    }
  }
  limitFileSize();
</script>
{% endblock %}
