{% load i18n %}

<h2 id="results_list" class="mdc-typography--display1 mdc-theme--secondary">{% trans 'Results' %}</h2>

{% for r in search_results|dictsortreversed:"count" %}
  {% if forloop.first %}
    {% if r.count == 0 %}
      <div>{% trans 'No search results' %}</div>
    {% else %}
      <div class="pagination">
          <span>
              {% if paginator.has_previous %}
                  <span class="search-nav search-nav--back"><i class="icon ion-ios-arrow-back"></i></span>
              {% endif %}

              <span class="current">
                  {% trans 'Page' %} {{ paginator.number }} / {{ paginator.paginator.num_pages }}
              </span>

              {% if paginator.has_next %}
                  <span class="search-nav search-nav--forward"><i class="icon ion-ios-arrow-forward"></i></span>
              {% endif %}
          </span>
      </div>
    {% endif %}
  {% endif %}
{% endfor %}

{% for search_results_term in search_results|dictsortreversed:"term" %}
  {% if search_results_term.count > 0 %}
  <div class="search-set">
    <h3 class="mdc-theme--secondary-bg">
      "{{ search_results_term.term }}"
      <i class="icon ion-ios-arrow-forward"></i>
      <span class="filter-count">{{ search_results_term.count }}</span>/<span class="filter-count-total">{{ search_results_term.count }}</span> {% trans 'results' %}
    </h3>

    {% for g in search_results_term.questions|dictsortreversed:"answer_count"  %}
    <div class="mdc-card"
         id="{{ g.id|safe }}"
         discipline="'{{ g.discipline|safe }}'"
         category="{% for c in g.category.all %}{{ c.title|safe }} {% endfor %}"
         matrix="{{ g.get_matrix|safe }}">
      <div class="mdc-typography--title bold">
        {{ g.title|safe }}
      </div>

      <div class="mdc-typography--caption">
        #{{ g.id|safe }} {% if g.user %}{% trans 'by' %} {{ g.user.username|safe }}{% endif %}
      </div>

      <div class="mdc-typography--body1 m-top-5">
        {{ g.text|safe }}
      </div>

      {% if g.image %}
        <img class="question-image hidden" src="{{ g.image.url|safe }}" alt="g.image_alt_text">
      {% endif %}

      {% if g.video_url %}
      <div id="question-video">
        <object class="question-image" width="640" height="390" data="{{ g.video_url|safe }}"></object>
      </div>
      {% endif %}


      <div class="question-answers hidden">
        <ul>
          {% for label, choice in g.get_choices %}
            <li class="dense-list">{{ label }}. {{ choice|safe }}
            {% for c in g.answerchoice_set.all %}
              {% if forloop.counter == forloop.parentloop.counter %}
                {% if c.correct %}
                  <i id="check" class="material-icons check-12">check</i>
                {% endif %}
              {% endif %}
            {% endfor %}
            </li>
          {% endfor %}
        </ul>
      </div>

      <div class="mdc-card__actions">

        <div class="mdc-card__action-buttons grey">
          <div class="mdc-typography--caption">
            <div>
              {% trans 'Discipline' %}: {{ g.discipline|safe }}
            </div>
            <div>
              {% trans 'Categories' %}:
              {% for c in g.category.all %}
              {{ c.title|safe }}{% if not forloop.last %}, {% endif %}
              {% empty %}
              {% trans 'Uncategorized' %}
              {% endfor %}
            </div>
            <div>
              {% trans 'Student answers' %}: {{ g.answer_set.all.count }}
            </div>
          </div>
        </div>

        <div class="mdc-card__action-icons">

          <div id="stats-{{ g.id|safe }}" class="stats">
            <i id="activate-dialog-analytics-{{ g.id|safe }}"
            ref_id="{{ g.id|safe }}" class="material-icons md-24 analytics-tags">assessment</i>
            <span id="rating-{{ g.id|safe }}"></span>
          </div>

          {% if assignment %}
          <button class="material-icons small-button mdc-button mdc-card__action mdc-card__action--button mdc-button--raised m-left-20 update-questions-btn">add</button>
          {% elif type == None %}
          {% if request.user.teacher %}
          <i class="mdc-icon-toggle material-icons mdc-theme--primary favourite-btn"
              role="button"
              aria-pressed="false"
              aria-label="Add to favorites" tabindex="0"
              {% if g in request.user.teacher.favourite_questions.all %}
              data-toggle-off='{"label": "Remove from favourites", "content": "favorite"}'
              data-toggle-on='{"label": "Add to favourites", "content": "favorite_border"}'
              {% else %}
              data-toggle-on='{"label": "Remove from favourites", "content": "favorite"}'
              data-toggle-off='{"label": "Add to favourites", "content": "favorite_border"}'
              {% endif %}>
              favorite_border
          </i>
          {% endif %}
          {% else %}
          <form class="inline" method="post" action="#{{ g.id|slugify }}">
            {% csrf_token %}
            <input type="hidden" name="{{ form_field_name|safe }}" value="{{ g.pk|safe }}" />
            <input class="material-icons small-button mdc-button mdc-card__action mdc-card__action--button mdc-button--raised m-left-20" type="submit" value="add" />
          </form>
          {% endif %}
        </div>
      </div>
    </div>
    {% endfor %}

  </div>
  {% endif %}
{% endfor %}

{% for r in search_results|dictsortreversed:"count" %}
  {% if forloop.first %}
    {% if r.count > 0 %}
      <div class="pagination">
          <span>
              {% if paginator.has_previous %}
                  <span class="search-nav search-nav--back"><i class="icon ion-ios-arrow-back"></i></span>
              {% endif %}

              <span class="current">
                  {% trans 'Page' %} {{ paginator.number }} / {{ paginator.paginator.num_pages }}
              </span>

              {% if paginator.has_next %}
                  <span class="search-nav search-nav--forward"><i class="icon ion-ios-arrow-forward"></i></span>
              {% endif %}
          </span>
      </div>
    {% endif %}
  {% endif %}
{% endfor %}

{% block scripts %}
<script nonce="{{ request.csp_nonce }}">
  window.addEventListener("load", function() {
    [...document.getElementsByClassName("search-nav")].forEach(btn => {
      if (btn.classList.contains("search-nav--back")) {
        btn.addEventListener("click", () => {
          pageNav({{ paginator.previous_page_number }})
        })
      } else {
        btn.addEventListener("click", () => {
          pageNav({{ paginator.next_page_number }})
        })
      }

    })
    const updateBtns = document.getElementsByClassName("update-questions-btn")
    const favouriteBtns = document.getElementsByClassName("favourite-btn")
    {% for g in search_results_term.questions|dictsortreversed:"answer_count"  %}
    updateBtns[{{ forloop.counter0 }}].addEventListener("click", () => {
      ajax.updateAssignmentQuestionList('{% url 'assignment-edit-ajax' %}', '{{ g.id|safe }}', '{{ assignment.identifier|safe }}')
    })
    favouriteBtns[{{ forloop.counter0 }}].addEventListener("click", () => {
      toggleFavourite({{ g.pk|safe }})
    })
    {% endfor %}

  })
</script>
{% endblock %}
