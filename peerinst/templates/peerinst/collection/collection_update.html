{% extends 'peerinst/base.html' %}

{% load compress staticfiles add_class i18n %}
{% block stylesheets %}

<script src="{% static 'peerinst/js/tinymce/js/tinymce/tinymce.min.js' %}"></script>
<style nonce="{{ request.csp_nonce }}">
.spinning {
  opacity: 0;
  vertical-align: sub;
  animation: 1s ease-in-out infinite spin;
}
@keyframes spin {
  from { transform: rotate(0deg); }
  to   { transform: rotate(-180deg); }
}
.mdc-chip__icon--trailing {
  pointer-events: none;
}
.image-field {
  padding-top:6px;
  padding-bottom: 6px;
  padding-left: 16px;
  color: rgba(0,0,0,0.87);
  font-size: 14px;
  font-family: 'Montserrat', sans-serif;
}
.mdc-text-field__input {
    width:100%;
}
:not(.mdc-list--non-interactive)>.mdc-list-item::before, :not(.mdc-list--non-interactive)>.mdc-list-item::after{
  background-color: #F4F4F4;
}

</style>
{% endblock %}
{% block body %}
<main>
  <section>
    <div>
    <h2 class="mdc-typography--display1 mdc-theme--secondary">{% trans 'Update Your Collection of Assignments' %}</h2>

        <div class='field-container'>
          <div class='number-box'><span class='number'>?</span></div>
          <div class='field'>
            <p><small>
              {% blocktrans %}
              Please use this page to edit your collection of assignments. Please provide what discipline this collection would be most pertinent for,
              as well as a description which would help your colleagues understand how best to incorporate it into their pedagogy.
              {% endblocktrans %}
            </small></p>
          </div>
        </div>


<form id="collection-update-form" enctype="multipart/form-data" method="post">
    {% csrf_token %}


  <div class='field-container'>
    <div class='number-box flush-to-textbox'><span class='number'></span></div>
    <div class='field'>
      <div class="mdc-text-field mdc-text-field--outlined mdc-text-field--dense" data-mdc-auto-init="MDCTextField">
        {{ form.title|add_class:"mdc-text-field__input" }}
        {{ form.title.label_tag|add_class:"mdc-floating-label"|cut:":" }}
        <div class="mdc-notched-outline">
          <svg>
            <path class="mdc-notched-outline__path"/>
          </svg>
        </div>
        <div class="mdc-notched-outline__idle"></div>
      </div>
      <p class="mdc-text-field-helper-text mdc-text-field-helper-text--persistent" aria-hidden="true">
        {{ form.title.help_text|safe }}
      </p>
      {{ form.title.errors }}
    </div>
  </div>

  <div class='field-container'>
    <div class='number-box flush-to-textbox'><span class='number'></span></div>
    <div class="field">
              <div class="mdc-text-field mdc-text-field--textarea mdc-text-field--dense" data-mdc-auto-init="MDCTextField">
                {{ form.description|add_class:"mdc-text-field__input" }}
                {{ form.description.label_tag|add_class:"mdc-floating-label"|cut:":" }}
              </div>
              <p style="margin-left:16px;margin-right:16px;" class="mdc-text-field-helper-text mdc-text-field-helper-text--persistent" aria-hidden="true">
                {% trans 'Enter the description text.'  %}
              </p>

            </div>
  </div>


  <div class='field-container'>
    <div class='number-box'><span class='number'></span></div>
    <div class='field'>
      <div id='discipline_form'>
        <div class='mdc-form-field'>
          <label for='id_discipline'>{{ form.discipline.label }}:</label>
          <div class='mdc-select'>
            {{ form.discipline|add_class:"mdc-select__native-control" }}
            <div class="mdc-select__bottom-line"></div>
          </div>

        </div>

      </div>
      <p class="form-helper-text" aria-hidden="true">
        {{ form.discipline.help_text|safe }}
      </p>
      {{ form.discipline.errors }}
    </div>
  </div>

  <div class='field-container'>
    <div class='number-box'><span class='number'></span></div>
    <div class='field'>
      <div class='mdc-form-field' style="display:block;">
        <label for='id_image'>{{ form.image.label }}</label>
      </div>
      <div class='image-field'>
        {{form.image}}
        <span class='mdc-typography--body1 bold' id='warning' style='display:none;color:red;'>{% trans 'Max file size 1MB' %}</span>
      </div>
      <p class="form-helper-text" aria-hidden="true">
        {{ form.image.help_text|safe }}
      </p>
      {{ form.image.errors }}
    </div>

<div class='field-container'>
  <div class='number-box'><span class='number'></span></div>
  <div class='field'>
    <div class='mdc-form-field'>
      <label for="private">{{ form.private.label }}</label>
      <div class="mdc-checkbox">
        {{ form.private|add_class:'mdc-checkbox__native-control'}}
        <div class="mdc-checkbox__background">
          <svg class="mdc-checkbox__checkmark"
               viewBox="0 0 24 24">
            <path class="mdc-checkbox__checkmark-path"
                  fill="none"
                  stroke="white"
                  d="M1.73,12.91 8.1,19.28 22.79,4.59"/>
          </svg>
          <div class="mdc-checkbox__mixedmark"></div>
        </div>
      </div>
    </div>
    <p class="form-helper-text" aria-hidden="true">
      {{ form.private.help_text|safe }}
    </p>
    {{ form.private.errors }}
  </div>
  </div>

  <div class="mdc-list-group">
        <h3 class="mdc-list-group__subheader">{% trans 'Your Assignments' %}</h3>
        <ul class="mdc-list mdc-list--two-line mdc-list--avatar-list demo-list demo-list--with-avatars demo-list--icon-placeholders" aria-orientation="vertical">

          {% for assignment in my_assignments %}

          <li class="mdc-list-item">
            <span class="mdc-list-item__text">
              <span class="mdc-list-item__primary-text">{{assignment.title}}</span>
              <span class="mdc-list-item__secondary-text">{{assignment.questions.count}} {% trans 'Questions' %}</span>
            </span>
            <div class='field'>
              <div class='mdc-form-field'>
                <label for="assignments"></label>
                <div class="mdc-checkbox" style='right: 0px;'>
                  {{ form.assignments|add_class:'mdc-checkbox__native-control'}}
                  <div class="mdc-checkbox__background">
                    <svg class="mdc-checkbox__checkmark"
                         viewBox="0 0 24 24">
                      <path class="mdc-checkbox__checkmark-path"
                            fill="none"
                            stroke="white"
                            d="M1.73,12.91 8.1,19.28 22.79,4.59"/>
                    </svg>
                    <div class="mdc-checkbox__mixedmark"></div>
                  </div>
                </div>
              </div>
            </div>
          </li>

          {% endfor %}

        </ul>
        <hr class="mdc-list-divider mdc-list-divider--inset">
        <h3 class="mdc-list-group__subheader">{% trans 'Your Favorited Assignments' %}</h3>
        <ul class="mdc-list mdc-list--two-line mdc-list--avatar-list demo-list demo-list--with-avatars demo-list--icon-placeholders" aria-orientation="vertical">

          {% for assignment in followed_assignments %}

          <li class="mdc-list-item">
            <span class="mdc-list-item__text">
              <span class="mdc-list-item__primary-text">{{assignment.title}}</span>
              <span class="mdc-list-item__secondary-text">{{assignment.questions.count}} {% trans 'Questions' %}</span>
            </span>
            <a href="#" class="mdc-list-item__meta material-icons" aria-label="View more information" title="More info" onclick="event.preventDefault();" tabindex="-1">
              info
            </a>
          </li>

          {% endfor %}

        </ul>
      </div>



      <input class="mdc-button mdc-button--raised padded-top" type="submit" value="Update" />

      <input type="hidden" name="owner" value="">
</form>



</section>
</main>
{% endblock %}
{% block scripts %}

  <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
  <script nonce="{{ request.csp_nonce }}">
    'use strict';
    bundle.bindCheckbox();


    function updateForm(){
      if ($('#id_type').val() == "RO") {
        $('.peerinst').toggle(false);
      }
      else {
        $('.peerinst').toggle(true);
      }
      enumerate();
    }

    $('#id_type').change(function(){
      if (this.value != "{{question.type}}") {
        $('#next').find('button').attr('disabled', 'true');
      }
      else {
        $('#next').find('button').attr('disabled', false);
      }
      updateForm();
    });

    updateForm();

    function limitFileSize() {
      var imageForm = document.getElementById('id_image');
      var warning = document.getElementById('warning');
      imageForm.setAttribute('accept', '.png, .jpg, .jpeg, .gif');
      imageForm.onchange = function() {
        var fileSize = imageForm.files[0].size;
        if (fileSize > 1000000) {
          window.alert('File too big: '+fileSize/1000+'kB');
          warning.style.display = 'inline';
          $('.mdc-button').each(function() {
            $(this).attr('disabled',true);
          });
        }
        else {
          warning.style.display = 'none';
          $('.mdc-button').each(function() {
            $(this).attr('disabled',false);
          });
        }
        return;
      }
    }

    limitFileSize();

    // Generators for autocomplete
    const response = function(searchClass, spinnerId) {
      return function( event, ui ) {
        // NB: Pass by reference.  ui can be modified, but not recreated.
        let currentList = $.map($(searchClass), function(obj, i) {
          return $(obj).attr('d');
        });

        let tmp = ui.content.filter( function(el) {
          return !currentList.includes(el.label);
        });

        let l = ui.content.length
        while (l > 0) {
          ui.content.pop();
          l = ui.content.length;
        }

        for (let i = 0; i < tmp.length; i++) {
          ui.content.push(tmp[i]);
        }

        if (ui.content.length == 0) {
          // Could add hint that there are no results
        }

        $(spinnerId).css('opacity', 0);
        return;
      }
    }

    const search = function(spinnerId) {
      return function( event, ui ) {
        $(spinnerId).css('opacity', 1);
      }
    }

    const focus = function( event, ui ) {
      event.preventDefault();
      $(this).val(ui.item.label);
    }

    const select = function(currentIds, className, formId) {
      return function( event, ui ) {
        event.preventDefault();
        $(this).val("");

        $(currentIds).append("<div d="+ui.item.label+" v="+ui.item.value+" class='mdc-chip mdc-typography--caption "+className+"' onclick=\"updateSelect(this,\'"+formId+"\');\" tabindex='0' data-mdc-auto-init='MDCChip'>\
          <div class='mdc-chip__text'>"+ui.item.label+"</div>\
          <i class='material-icons mdc-chip__icon mdc-chip__icon--trailing' tabindex='0' role='button'>cancel</i>\
          </div>");

        $(formId).append("<option selected='selected' value="+ui.item.value+">"+ui.item.label+"</option>");
      }
    }

    function updateSelect(el, formId) {
      el.remove();
      $(formId).find("[value="+$(el).attr('v')+"]").remove();
    }
  bundle.addDialog();
  bundle.bindCheckbox();
  function enumerate(){
    var counter = 1;
    $('.number-box:visible').each(function() {
      var el = $(this).children('.number')[0];
      if (el.innerHTML == "") {
        el.innerHTML = counter;
        counter++;
      }
      return;
    });
  }
  enumerate();
</script>
{% endblock %}
