!function(e){"use strict";function t(){return document.getElementsByName("csrfmiddlewaretoken")[0].getAttribute("value")}function n(e,n){if("get"===n.toLowerCase())return{method:n.toUpperCase(),headers:{"Content-Type":"application/json","X-CSRFToken":t()}};if("post"===n.toLowerCase()){const o=e?JSON.stringify(e):"";return{method:n.toUpperCase(),body:o,headers:{"Content-Type":"application/json","X-CSRFToken":t()}}}throw Error("Method ".concat(n," not implemented yet."))}let o,a,s;async function i(){await async function(){const e=n({},"post"),t=await fetch(o.urls.daliteMessages,e),a=await t.json();o.messages=a.messages.map(e=>({id:e.id,title:e.title,text:e.text,colour:e.colour,removable:e.removable,date:e.date,link:e.link,authors:e.authors.map(e=>({name:e.name,picture:e.picture}))}))}()}function r(){!function(){const e=document.querySelector("#dalite-messages");o.messages.length?(e.classList.remove("hidden"),o.messages.forEach(t=>{e.appendChild(function(e){const t=document.createElement("div");t.classList.add("mdc-card");const a=document.createElement("div");e.link&&(a.addEventListener("click",()=>{window.location.assign(e.link)}),a.style.setProperty("cursor","pointer"),a.title=e.link);const s=document.createElement("div");s.classList.add("mdc-typography--title","bold"),s.textContent=e.title,a.appendChild(s);const i=document.createElement("div");i.classList.add("mdc-typography--caption"),i.textContent=e.date,a.appendChild(i);const r=document.createElement("div");r.classList.add("mdc-typography--body1"),r.innerHTML=e.text,a.appendChild(r),t.appendChild(a);const c=document.createElement("div");c.classList.add("mdc-card__actions");const l=document.createElement("div");if(l.classList.add("mdc-card__action-buttons"),e.authors.length){const t=document.createElement("div");t.classList.add("dalite-message__authors"),e.authors.forEach(e=>{const n=document.createElement("img");n.classList.add("dalite-message__authors_author"),n.title=e.name,n.setAttribute("src",e.picture?e.picture:o.urls.saltiseImage),n.setAttribute("alt","Picture of ".concat(e.name)),t.appendChild(n)}),l.appendChild(t)}if(c.appendChild(l),e.removable){const a=document.createElement("div");a.classList.add("mdc-card__action-icons");const s=document.createElement("i");s.classList.add("mdc-icon-toggle","material-icons","mdc-theme--primary"),s.textContent="clear",s.addEventListener("click",async()=>{await async function(e,t){const a=n({id:e.id},"post");var s;(await fetch(o.urls.removeDaliteMessage,a)).ok&&(3==(s=t).parentNode.childElementCount?s.parentNode.remove():s.remove())}(e,t)}),a.appendChild(s),c.appendChild(a)}return t.appendChild(c),t.style.setProperty("background-color",e.colour),t}(t))})):e.remove()}()}async function c(e){!function(e){o={urls:{daliteMessages:e.urls.daliteMessages,removeDaliteMessage:e.urls.removeDaliteMessage,saltiseImage:e.urls.saltiseImage},messages:[]}}(e),await i(),r()}function l(){document.querySelectorAll(".custom-report__rationale").forEach(e=>{d(e)})}function d(e){const t=e.getAttribute("data-score");if(""!=t){const n=parseInt(t);0==n?(e.querySelector(".flag").setAttribute("data-flagged",""),e.querySelectorAll(".star").forEach((e,t)=>{e.removeAttribute("data-starred")})):(e.querySelector(".flag").removeAttribute("data-flagged"),e.querySelectorAll(".star").forEach((e,t)=>{3-t<=n?e.setAttribute("data-starred",""):e.removeAttribute("data-starred")}))}}function u(){document.querySelectorAll(".custom-report__rationale__evaluation").forEach(e=>{m(e.querySelector(".flag")),e.querySelectorAll(".star").forEach(e=>f(e))})}function m(e,t=!1){t||e.hasAttribute("data-flagged")?e.textContent="flag":e.textContent="outlined_flag"}function f(e,t=!1){const n=[...e.parentNode.getElementsByClassName("star")],o=n.indexOf(e);n.forEach((e,n)=>{e.hasAttribute("data-starred")||t&&n>=o?e.textContent="star":e.textContent="star_border"})}function g(){document.querySelectorAll(".custom-report__rationale__evaluation .flag").forEach(e=>{e.addEventListener("mouseenter",()=>m(e,!0)),e.addEventListener("mouseleave",()=>m(e,!1)),e.addEventListener("click",()=>async function(e){const t=e.parentNode.parentNode,o=n({id:e.parentNode.parentNode.getAttribute("data-id"),score:0,redirect:!1},"post");(await fetch(a.urls.evaluateRationale,o)).ok&&(e.setAttribute("data-flagged",""),t.setAttribute("data-score","0")),d(t),u()}(e))}),document.querySelectorAll(".custom-report__rationale__evaluation").forEach(e=>{e.querySelectorAll(".star").forEach((e,t)=>{e.addEventListener("mouseenter",()=>f(e,!0)),e.addEventListener("mouseleave",()=>f(e,!1)),e.addEventListener("click",()=>async function(e,t){const o=e.parentNode.parentNode,s=n({id:e.parentNode.parentNode.getAttribute("data-id"),score:t,redirect:!1},"post");(await fetch(a.urls.evaluateRationale,s)).ok&&(flag.setAttribute("data-flagged",""),o.setAttribute("data-score","".concat(t))),d(o),u()}(e,3-t))})})}function p(e){for(;e.hasChildNodes();)e.removeChild(e.lastChild);return e}function h(e,t=!0){const n=document.createElementNS("http://www.w3.org/2000/svg","svg"),o=document.createElementNS("http://www.w3.org/2000/svg","use");return o.setAttributeNS("http://www.w3.org/1999/xlink","href",function(e,t=!0){return t?"#".concat(e):window.location.protocol+"//"+window.location.host+"/static/peerinst/icons.svg#"+e}(e,t)),n.append(o),n}function _(){const e=document.querySelector(".notifications");document.querySelectorAll(".header--togglable > *").forEach(t=>{t!=e&&t.hasAttribute("open")&&(t.shadowRoot?t.shadowRoot.querySelector(".header__icon").dispatchEvent(new Event("click")):t.querySelector(".header__icon").dispatchEvent(new Event("click")))}),s.notificationsOpen=!s.notificationsOpen,y()}function v(e){s.notifications=e,y()}function y(){const e=document.querySelector(".notifications"),t=null==e?void 0:e.querySelector(".notifications__icon__badge"),n=null==e?void 0:e.querySelector(".notifications__notifications");if(!e||!t||!n)return;const o=s.notifications.filter(e=>!e.inProgress);var a,i;(o.length>0?(t.textContent=o.length.toString(),t.style.display="flex"):(t.textContent="",t.style.display="none"),p(n),s.notifications.length?(s.notifications.map((function(e){n.appendChild(function(e){const t=document.createElement("div");if(t.classList.add("notification"),t.addEventListener("click",e.onClick),e.inProgress){const e=document.createElement("loading-spinner");e.classList.add("notification__spinner"),t.appendChild(e)}else{let n;e.error?(n=h("error"),n.classList.add("notification__icon--error")):(t.classList.add("notification--completed"),n=h("cloud_download")),n.classList.add("notification__icon"),t.appendChild(n)}const n=document.createElement("span");n.classList.add("notification__description"),n.innerHTML=e.text,t.appendChild(n);const o=h("close");return o.classList.add("notification__close"),o.addEventListener("click",e.onCloseClick),t.appendChild(o),t}(e))})),document.querySelector(".notifications__clear-all-btn").removeAttribute("hidden")):(n.appendChild(function(){const e=document.createElement("div");return e.textContent="No new notifications",e}()),document.querySelector(".notifications__clear-all-btn").setAttribute("hidden","")),s.notifications.some(e=>e.inProgress))?null===(a=document.querySelector(".notifications__spinner"))||void 0===a||a.classList.add("notifications__spinner--loading"):null===(i=document.querySelector(".notifications__spinner"))||void 0===i||i.classList.remove("notifications__spinner--loading");s.notificationsOpen?(e.setAttribute("open",""),e.classList.add("notifications--open")):(e.removeAttribute("open"),e.classList.remove("notifications--open"))}function b(){var e,t,n,o;null===(e=document.querySelector(".notifications"))||void 0===e||e.addEventListener("click",(function(e){e.stopPropagation()})),null===(t=document.querySelector(".notifications__icon"))||void 0===t||t.addEventListener("click",(function(e){_()})),null===(n=document.body)||void 0===n||n.addEventListener("click",(function(e){s.notificationsOpen&&(e.stopPropagation(),_())})),null===(o=document.querySelector(".notifications__clear-all-btn"))||void 0===o||o.addEventListener("click",()=>{s.notifications.forEach(e=>{e.onCloseClick()})})}let E,k,w;function q(){!function(){const e=E.urls.tasks,t=n({},"get");fetch(e,t).then(e=>e.json()).then(e=>{!async function(e){E.tasks=e.map(e=>({id:e.id,description:e.description,completed:e.completed,datetime:new Date(e.datetime),error:!1})).sort((e,t)=>e.datetime>t.datetime?-1:e.datetime<t.datetime?1:0),v(S()),Promise.all(E.tasks.filter(e=>!e.completed).map(e=>L(e)))}(e.tasks)})}()}async function L(e){const t=E.urls.gradebookResult,o=n({task_id:e.id},"post"),a=await fetch(t,o);200==a.status?(e.completed=!0,v(S())):202==a.status?await new Promise(t=>setTimeout(()=>L(e),1e3)):(e.completed=!0,e.error=!0,v(S()))}function C(e,t){const n=document.createElement("a");n.href="data:text/csv;charset=utf-8, ".concat(escape(t)),n.target="_blank",n.download=e,document.body.appendChild(n),n.click(),document.body.removeChild(n)}function S(){return E.tasks.map(e=>({text:e.completed?e.error?"There was an error creating the gradebook for ".concat(e.description,"."):"The ".concat(e.description," is ready."):"Computing the ".concat(e.description,"..."),inProgress:!e.completed,error:e.error,onClick:e.completed&&!e.error?async()=>await async function(e){const t={task_id:e.id},o=E.urls.downloadGradebook,a=n(t,"post"),s=await fetch(o,a);if(s.ok){const t=await s.text();C(t.split("\n")[0],t.split("\n").slice(1).join("\n")),E.tasks=E.tasks.filter(t=>t.id!=e.id),v(S())}else console.log(s)}(e):async()=>{},onCloseClick:async()=>await async function(e){const t=E.urls.removeFailedGradebook,o=n({task_id:e.id},"post");(await fetch(t,o)).ok&&(E.tasks=E.tasks.filter(t=>t.id!==e.id)),v(S())}(e)}))}function A(){[...document.getElementsByClassName("gradebook-button")].forEach(e=>{e.addEventListener("click",async e=>await async function(e){e.stopPropagation();const t=e.currentTarget,o={group_id:t.getAttribute("data-group"),assignment_id:t.getAttribute("data-assignment")},a=E.urls.requestGradebook,s=n(o,"post"),i=await fetch(a,s);if(200===i.status){const e=await i.text();C(e.split("\n")[0],e.split("\n").slice(1).join("\n"))}else if(201===i.status){const e=await i.json(),t={id:e.id,description:e.description,completed:e.completed,datetime:new Date(e.datetime),error:!1};E.tasks.unshift(t),setTimeout(()=>L(t),0),v(S())}else console.log(i)}(e))})}function N(){!function(){const e=k.urls.messagesUrl,t=n({},"get");fetch(e,t).then(e=>e.json()).then(e=>{k.messages=e.threads.map(e=>({id:e.id,title:e.title,lastReply:{author:e.last_reply.author,content:e.last_reply.content,date:e.last_reply.date},nNew:e.n_new,link:e.link})),T()})}()}function R(){const e=document.querySelector(".messages");document.querySelectorAll(".header--togglable > *").forEach(t=>{t!=e&&t.hasAttribute("open")&&(t.shadowRoot?t.shadowRoot.querySelector(".header__icon").dispatchEvent(new Event("click")):t.querySelector(".header__icon").dispatchEvent(new Event("click")))}),k.open=!k.open,T()}function T(){const e=document.querySelector(".messages"),t=null==e?void 0:e.querySelector(".messages__icon__badge"),n=null==e?void 0:e.querySelector(".messages__messages");if(!e||!t||!n)return;M(),p(n),document.querySelector(".messages__read-all-btn").classList.add("hidden");k.messages.filter(e=>e.nNew>0).length&&document.querySelector(".messages__read-all-btn").classList.remove("hidden"),k.messages.length?k.messages.map((function(e){n.appendChild(P(e))})):n.appendChild(function(){const e=document.createElement("div");return e.textContent="No messages",e}()),k.open?(e.setAttribute("open",""),e.classList.add("messages--open")):(e.removeAttribute("open"),e.classList.remove("messages--open"))}function M(){const e=document.querySelector(".messages__icon__badge"),t=k.messages.filter(e=>e.nNew>0).length;t?(e.textContent=t.toString(),e.style.display="flex"):(e.textContent="",e.style.display="none")}function P(e,t=null){t?p(t):((t=document.createElement("div")).classList.add("message"),t.addEventListener("click",()=>{window.location.href=e.link}));const o=document.createElement("div");if(o.classList.add("message__title"),o.textContent=e.title,t.appendChild(o),e.nNew?t.classList.add("message--new"):t.classList.remove("message--new"),e.nNew){const e=document.createElement("div");e.classList.add("message__new"),e.textContent="New!",t.appendChild(e)}if(e.lastReply.author){const o=document.createElement("div");o.classList.add("message__last-reply"),t.appendChild(o);const a=document.createElement("span");a.classList.add("message__last-reply__content"),a.textContent=e.lastReply.content,o.appendChild(a);const s=document.createElement("div");if(s.classList.add("message__last-reply__author"),s.innerHTML=e.lastReply.author+" &middot; "+e.lastReply.date,e.nNew){const o=document.createElement("span");o.classList.add("message__mark-read"),o.textContent="clear",o.title="Mark read",o.addEventListener("click",o=>async function(e,t,o){e.stopPropagation();const a=n({id:t.id},"post");(await fetch(k.urls.markReadUrl,a)).ok&&(t.nNew=0),P(t,o),M()}(o,e,t)),s.appendChild(o)}o.appendChild(s)}return t}function Q(){var e,t,o,a;null===(e=document.querySelector(".messages"))||void 0===e||e.addEventListener("click",(function(e){e.stopPropagation()})),null===(t=document.querySelector(".messages__icon"))||void 0===t||t.addEventListener("click",(function(e){R()})),null===(o=document.body)||void 0===o||o.addEventListener("click",(function(e){k.open&&(e.stopPropagation(),R())})),null===(a=document.querySelector(".messages__read-all-btn"))||void 0===a||a.addEventListener("click",()=>async function(){const e=n({},"post");(await fetch(k.urls.markReadUrl,e)).ok&&k.messages.forEach(e=>{e.nNew=0}),T()}())}const F={duration:600,direction:"right",easing:"easeInOutCubic"};async function H(){await async function(){const e=n({},"get"),t=await fetch(w.urls.getFlagQuestionReasons,e);t.ok||console.log(t);const o=await t.json();w.flagQuestionReasons=o.reasons,G()}()}function j(e){const t=e.getAttribute("open"),n=e.getAttribute("data-id"),o=e.querySelector(".flag-question__form"),a=e.querySelector(".flag-question__btn");null===n&&console.log("The flag question div needs a `data-id` attribute representing the question pk."),null===t?(e.setAttribute("open",""),o.removeAttribute("hidden"),a.textContent="flag"):(e.removeAttribute("open"),o.setAttribute("hidden",""),a.textContent="outlined_flag")}async function D(e){const t=e.getAttribute("data-id"),o=e.querySelector(".flag-question__form__select"),a=n({id:t,reason:o.options[o.selectedIndex].value},"post"),s=await fetch(w.urls.flagQuestion,a);s.ok||console.log(s),j(e),await async function(e){const t=$.get(w.urls.getNewQuestion);t.done(t=>{$(e).toggle("fade",()=>{$(e).remove(),$("#questions").append(t),$("#questions .mdc-card").hide().toggle("slide",F),I(w.urls.toggleFavourite,w.urls.getNewQuestion),window.location.href="#questions"})}),t.fail(()=>{x.innerHTML="error",window.setTimeout(()=>{x.innerHTML="autorenew"},5e3)})}(e.parentNode.parentNode.parentNode)}function G(){[...document.getElementsByClassName("flag-question")].forEach(e=>{const t=e.querySelector(".flag-question__form select");p(t),w.flagQuestionReasons.forEach(e=>{const n=document.createElement("option");n.classList.add("flag-question__form__option"),n.value=e,n.textContent=e,t.appendChild(n)})})}function I(e,t){$("#questions .mdc-card").each((n,o)=>{"true"!==o.getAttribute("initialized")&&(o.setAttribute("initialized","true"),$(o).find(".mdc-icon-toggle.favourite-btn").each((t,n)=>{bundle.iconToggle.MDCIconToggle.attachTo(n),n.addEventListener("click",()=>{$.post(e,{pk:n.getAttribute("data-id")}).done(e=>{console.log(e)})})}),$(o).find(".remove-btn").each((n,a)=>{a.addEventListener("click",()=>{const n=$.get(t);n.done(n=>{$(o).toggle("fade",()=>{$(o).remove(),$("#questions").append(n),$("#questions .mdc-card").hide().toggle("slide",F),I(e,t),window.location.href="#questions"})}),n.fail(()=>{a.innerHTML="error",window.setTimeout(()=>{a.innerHTML="autorenew"},5e3)})})}))}),[...document.getElementsByClassName("flag-question")].forEach(e=>{e.querySelector(".flag-question__close").addEventListener("click",t=>{t.stopPropagation(),j(e)}),e.querySelector(".flag-question__btn").addEventListener("click",t=>{t.stopPropagation(),j(e)}),e.querySelector(".flag-question__form").addEventListener("click",e=>{e.stopPropagation()}),e.querySelector(".flag-question__form").addEventListener("submit",t=>{t.preventDefault(),D(e)}),document.body.addEventListener("click",()=>{e.hasAttribute("open")&&j(e)})}),G()}const O={duration:600,direction:"right",easing:"easeInOutCubic"};let B;function U(e,t){B={flagQuestionReasons:[],urls:{flagQuestion:e,getFlagQuestionReasons:t}},async function(){const e=n({},"get"),t=await fetch(B.urls.getFlagQuestionReasons,e);t.ok||console.log(t);const o=await t.json();B.flagQuestionReasons=o.reasons,[...document.getElementsByClassName("flag-question")].forEach(e=>{const t=e.querySelector(".flag-question__form select");p(t),B.flagQuestionReasons.forEach(e=>{const n=document.createElement("option");n.classList.add("flag-question__form__option"),n.value=e,n.textContent=e,t.appendChild(n)})})}()}function z(e){const t=e.getAttribute("open"),n=e.getAttribute("data-id"),o=e.querySelector(".flag-question__form"),a=e.querySelector(".flag-question__btn");null===n&&console.log("The flag question div needs a `data-id` attribute representing the question pk."),null===t?(e.setAttribute("open",""),o.removeAttribute("hidden"),a.textContent="flag"):(e.removeAttribute("open"),o.setAttribute("hidden",""),a.textContent="outlined_flag")}function X(){[...document.getElementsByClassName("flag-question")].forEach(e=>{e.querySelector(".flag-question__close").addEventListener("click",t=>{t.stopPropagation(),z(e)}),e.querySelector(".flag-question__btn").addEventListener("click",t=>{t.stopPropagation(),z(e)}),e.querySelector(".flag-question__form").addEventListener("click",e=>{e.stopPropagation()}),e.querySelector(".flag-question__form").addEventListener("submit",t=>{t.preventDefault(),async function(e){const t=e.getAttribute("data-id"),o=e.querySelector(".flag-question__form__select"),a=n({id:t,reason:o.options[o.selectedIndex].value},"post"),s=await fetch(B.urls.flagQuestion,a);s.ok||console.log(s),z(e)}(e)}),document.body.addEventListener("click",()=>{e.hasAttribute("open")&&z(e)})})}e.initCustomReport=function(e){!function(e){a={urls:{evaluateRationale:e.evaluateRationale}}}(e),l(),u(),g()},e.initDashboard=async function(e){c({urls:{daliteMessages:e.urls.dalite_messages,removeDaliteMessage:e.urls.remove_dalite_message,saltiseImage:e.urls.saltise_image}})},e.initGradebooks=function(e){!function(e){E={tasks:[],urls:{requestGradebook:e.requestGradebook,gradebookResult:e.gradebookResult,removeFailedGradebook:e.removeFailedGradebook,downloadGradebook:e.downloadGradebook,tasks:e.tasks}}}(e),q(),A()},e.initMessages=function(e){!function(e){k={open:!1,messages:[],urls:e}}(e),N(),T(),Q()},e.initNotifications=function(){s={notificationsOpen:!1,notifications:[]},y(),b()},e.initQuestionCards=async function(e,t,n,o){!function(e,t,n,o){w={flagQuestionReasons:[],urls:{flagQuestion:e,getFlagQuestionReasons:t,getNewQuestion:n,toggleFavourite:o}}}(o,n,t,e),I(e,t),H()},e.initRationalesToScoreCards=function e(t){$("#rationales .mdc-card").each((n,o)=>{const a=o.getAttribute("data-id");let s;function i(n){$(o).toggle("fade",()=>{$(o).remove(),$("#rationales").append(n),$("#rationales .mdc-card").hide().toggle("slide",O),e(t),document.getElementsByTagName("teacher-reputation-header")[0].setAttribute("stale","")})}$(o).find(".star").each((e,n)=>{n.addEventListener("mouseover",()=>{s=n.getAttribute("data-rank"),$(".star").each((e,t)=>{t.getAttribute("data-rank")<=s?t.innerHTML="star":t.innerHTML="star_border"})}),n.addEventListener("mouseout",()=>{$(".star").each((e,t)=>{t.innerHTML="star_border"})}),$(n).one("click",()=>{$.post(t,{id:a,score:s}).done(e=>{i(e)})})}),$(o).find(".flag").each((e,n)=>{n.addEventListener("mouseover",()=>{$(".flag").each((e,t)=>{t.innerHTML="flag"})}),n.addEventListener("mouseout",()=>{$(".flag").each((e,t)=>{t.innerHTML="outlined_flag"})}),$(n).one("click",()=>{$.post(t,{id:a,score:0}).done(e=>{i(e)})})})})},e.initSearchFlag=async function(e,t){await U(t,e),X()},e.initStudentActivityCards=function(e){function t(){$(".progress-chart").each((t,n)=>{const o=e[n.getAttribute("group")][n.getAttribute("assignment")];bundle.plotTimeSeries(n,o)})}t(),window.addEventListener("resize",t)}}(this.teacher=this.teacher||{});
//# sourceMappingURL=teacher.min.js.map
